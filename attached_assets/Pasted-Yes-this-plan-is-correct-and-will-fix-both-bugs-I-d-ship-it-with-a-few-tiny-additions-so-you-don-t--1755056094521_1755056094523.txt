Yesâ€”this plan is correct and will fix both bugs. Iâ€™d ship it with a few tiny additions so you donâ€™t create new edge-case issues.

### âœ… Your steps (agree)

* **Step 1 (mapping):** Change `email` â†’ `paypalEmail` in the recipient mapper **and** in the checksum inputs.
* **Step 2 (eligibility):** Use `eq(isSealed, true)` and update status filter.
* **Step 3â€“4 (tests/validation):** Exactly right.

### ğŸ”§ Add these small safeguards (1â€“2 min each)

1. **Normalize emails before checksum & send**

   * Trim + lowercase (`paypalEmail.trim().toLowerCase()`), or youâ€™ll get checksum mismatches and occasional PayPal rejections due to case/whitespace.

2. **Sender item ID format (double-check)**

   * Ensure you still send `sender_item_id = 'winner-{cycleWinnerSelectionId}-{userId}'` so the parser maps items back to rows.

3. **Think about including `processing`**

   * If thereâ€™s any chance a batch is running, filtering `processing` winners can collide with the in-flight batch.
   * If you keep `processing` in eligibility, also ensure your **advisory lock** (per cycle) is active so you never double-pick in concurrent runs.
   * Safer default for bulk runs is **`['pending']` only** unless youâ€™re explicitly retrying stuck items.

4. **Zero-eligible guard**

   * If after filtering there are 0 recipients, return a 400 with a clear message (prevents empty â€œsuccessâ€).

5. **Preview parity**

   * Make sure the **preview** endpoint and **process** endpoint use **identical** filters and field names; otherwise preview will say â€œ750 eligibleâ€ and process will see 0.

### ğŸ§ª Quick validation script (what to look for)

* **Selective (5 IDs):** No â€œInvalid PayPal email â€¦ undefinedâ€ logs; PayPal payload shows proper emails.
* **Bulk (processAll):** Eligible â‰ˆ 750; batch created with deterministic `sender_batch_id`; items have correct `sender_item_id`.
* **Idempotency:** Re-run immediately â†’ returns existing batch summary, no new PayPal call.
* **DB state:** `payout_status` flips to `completed/failed/pending`; `notification_displayed=false` for completed; cycle â†’ `completed`/`partially_completed`.
* **History/Banner:** Rewards history populated; banner shows and dismiss persists.

Make those small additions and youâ€™re good to push.
